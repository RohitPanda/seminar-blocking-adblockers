# **AdBlocker Study Source Code** #

This code has 3 different components, each having their own dependencies and functionality.

## **The JavaScript Extractor (JS-Ext)** ##
This program will look in a given [HAR](https://en.wikipedia.org/wiki/.har) folder and HTML folder for things that look like embedded or downloaded JavaScript code. It extracts these and stores them in a folder structure that supports the remaining components of this suite.

### Installing Python Dependencies (some of these may be included in default installations of Python 2.7)
```
#!bash
sudo pip install hashlib haralyzer BeautifulSoup difflib progressbar re json glob
```

### Running the JavaScript Extractor
```
#!text
python main.py [-h] [--debug] -html HTML [-har HAR] [-urls URL] -dst STORE -sim SIM
```

The '-url' switch is used to point to the file containing the URLs corresponding to the provided source files.

The '-html' and '-har' switches set the paths to the folders containing the HTML and HAR source files, respectively. The '-har' switch is optional, but the '-html' switch is not. The names of the .html files need to match the indices in the specified URL file. The .har files need to be in the same format provided by the [Firebug NetExport](http://www.softwareishard.com/blog/netexport/) extension.

The '-dst' switch points to the folder that you'd like the extracted JavaScript files to be stored.

The '-sim' switch is useful when there are too many scripts in your source files and you'd only like to extract ones which differ from each other by some amount. Set this to a value between 0 and 1. The higher the value, the more scripts you get in your output.

Here is a sample run:

```
#!bash

cd js-extract-python

python main.py -html ../../data-pagefair/html/ -har ../../data-pagefair/har/ -urls ./url-list/pagefair-urls -dst ../pagefair-results/javascript -sim .5
```

## **The JavaScript Similarity Matrix Generator (JS-Sim)** ##
This program will generate a matrix that contains the pairwise similarity scores for every pair of JavaScript file in a specified location. The matrices are stored in the .npy format and can be used for later analysis.

### Installing Python Dependencies (excluding the ones mentioned above)
```
#!bash
sudo pip install scikit-learn
```

### Running the Similarity Matrix Generator
```
python main.py [-h] [--debug] --input_folder INPUT --output_folder OUTPUT --method METHOD --min_line_ratio RATIO --total-workers WORKERS --worker-id WID [--intersite] --statfile STATS
```

The '--input_folder' switch needs to point to the folder containing the JavaScript files you'd like to compare. These don't have to be structured the same way that is generated by the JS-Ext code. 

The '--output_folder' switch needs to point to the folder that will contain the generated .npy matrix/matrices. 

The '--min_line_ratio' switch determines the minimum length ratio between two JavaScript files before we will actually do a similarity check. If their length ratio is less than this value, we simply set the similarity score to be 0. This is a great way to remove pointless comparisons.

The '--method' switch takes a similarity metric as input. Currently, we support (in order of speed): "quick-difflib", "difflib", "tfidf-cosine-pair", and "tfidf-cosine-full".

The '--total-workers' switch is used to allow parallelization of similarity computation. Set this to be number of simultaneous process you'd like to run. The more workers, the fewer similarity matrix cells will be done by each worker.

The '--worker-id' switch is the ID of the current worker. This value determines which cells will be computed by the current worker.

The '--intersite' flag is set if you don't want to compute a similarity score between JavaScripts loaded by the same site.

The '--statfile' is a JSON file which maps the scripts with some statistics. You can point this switch to the all-stats.log file generated by the JS-Ext program.

Here is an example run of the program, using the output of the JS-Ext run from above.

```
#!bash

cd similarity-matrix-generator

python main.py --input_folder ../pagefair-results/javascript --output_folder ../pagefair-results/js-similarity-tfidf --method tfidf-cosine-pair --min_line_ratio .5 -tw 12 -id 1 --statfile ../pagefair-results/javascript/all-stats.log 
```

## **The JavaScript Similarity Graph Analyzer (JS-Gan)** ##
This program generates a graph from the similarity matrix and extracts cliques from it. A .html report is generated containing the details of each clique and its members. It can also be simply used to generate a graph (and plot it), rather than to extract cliques.

### Installing Python Dependencies (excluding the ones mentioned above)
```
#!bash
sudo pip install networkx matplotlib html
```

### Running the JavaScript Similarity Graph Analyzer
```
#!bash
python main.py [-h] [--debug] [--cliques] [--cliquesize CS] --threshold THRESHOLD --input_folder INPUT --filemap FILEMAP --output_folder OUTPUT [--plot]
```

The '--input_folder' switch points to the folder containing the source '.npy' matrices.

The '--cliques' flag is used to specify if you want to extract cliques from the input matrix. If this flag is set, you need to use the '--cliquesize' switch to specify the minimum clique size that you're interested in extracting.

The '--threshold' switch takes a float between 0 and 1. This determines the similarity required between two JavaScript files for an edge to be assumed between them.

The '--filemap' switch points to the 'filemap' file generated by the JS-Sim. It maps JS files with the nodes in the graphs, and is needed in the same format by JS-Gan.

The '--plot' flag is set when you want to generate a topology plot showing how various JavaScripts are connected.

The '--output_folder' is where the generated HTML report and PDF plots are located.

Here is an example run of the program, using the output of the JS-Sim run from above.

```
#!bash

cd graph-generator

python main.py --cliques --cliquesize 20 --threshold .90 --input_folder ../pagefair-results/js-similarity-tfidf --filemap ../pagefair-results/js-similarity-tfidf/filemap --output_folder ../pagefair-results/clique-analysis

```